NostraC=function(a,b){this.options=b||{};this.context=a||{};this.options.api=this.options.api||"//torec.edumall.vn/nostra/rec"};NostraC.init=function(a,b){var c=new NostraC(a,b);window.nostrac=c;c.onReady();return window.nostrac};NostraC.prototype.onReady=function(){this.asyncRecommendIfNeeded();this.checkItemViewed()};
NostraC.prototype.asyncRecommendIfNeeded=function(){if(!window.jQuery)return console.error("NostraC: jQuery should be defined"),this;var a=this,b=this.findAnchors();b&&0<b.length&&a.asyncExecuteRequest(b,function(b){a.handleRecommendations(b);a.bindClickHandler();a.trackRecommendationImpression(b)});return this};NostraC.prototype.findAnchors=function(){return $(".rec-div-holder").map(function(a,b){return b.id}).toArray()};
NostraC.prototype.asyncExecuteRequest=function(a,b){var c=this;$.ajax({method:"GET",url:this.options.api,dataType:"json",data:{data:JSON.stringify({anchors:a,params:this.context})},async:!0,beforeSend:function(a){a.overrideMimeType("application/json; charset=UTF-8")}}).done(function(a){b?b.call(this,a):console.error("NostraC.asyncExecuteRequest: Callback is not given")}).fail(function(a,b){var d=b;/5../.test(a.statusCode().status)?d="System error":a.responseText&&(response=JSON.parse(a.responseText),
d=response.message);c.onRequestFailed(d)}).always(function(){})};NostraC.prototype.bindClickHandler=function(){$('a[href*="utm_source=nostra_rec"').click(function(){nostrac.onItemClicked(this);return!0})};NostraC.prototype.handleRecommendations=function(a){a=a.recs;for(var b in a){var c=a[b];c.items&&$("#"+c.anchor.replace(/(:|\.|\[|\]|,)/g,"\\$1")).html(c.layout)}};NostraC.prototype.onRequestFailed=function(a){console.error('NostraC: Request failed "'+a+'".')};
NostraC.prototype.trackRecommendationImpression=function(a){var b=[],c;for(c in a.recs)a.recs[c].items&&b.push({recid:a.recs[c].recid,items:a.recs[c].items});0<b.length&&(a={recs:b,context:this.context},"undefined"!==typeof Spymaster&&Spymaster.track("nostra","impressed",null,a))};
NostraC.prototype.onItemClicked=function(a){a=$(a).attr("href")||"";a=this.parseParams(a);"nostra_rec"==a.utm_source&&(a={recid:a.recid,itemid:a.itemid,context:this.context},"undefined"!==typeof Spymaster&&Spymaster.track("nostra","click",null,a))};NostraC.prototype.checkItemViewed=function(){var a=this.parseParams(document.location.href)||{};"nostra_rec"==a.utm_source&&(a={recid:a.recid,itemid:a.itemid,context:this.context},"undefined"!==typeof Spymaster&&Spymaster.track("nostra","view",null,a))};
NostraC.prototype.parseParams=function(a){var b=(a||"").split("?");b.shift();b=b.join("?");a={};var b=b.split("&"),c;for(c in b){var e=b[c].split("=");a[e[0]]=e[1]}return a};
